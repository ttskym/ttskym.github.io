title: Windows 口令猜解(445，3389)
date: 2015-08-24 23:08:31
tags: 
 - hack
 - windows
 - NetBIOS
 - RDP
---
口令猜解是远程攻击Windows系统的重要方式之一。比较常用的是利用文件和打印共享服务以及终端服务/远程桌面服务两种服务进行猜解。众多的自动化猜解工具中，以medusa和hydra表现较好，两者都包含smb模块，利用smb协议猜解，此外hydra还支持rdp协议的猜解。

<!--more-->

文件和打印共享服务
----
从某种意义上说，windows7后的版本在文件和打印共享服务的默认配置中提高安全性，但是它仍然可能成为我们攻破Windows的重要突破口。

Windows SMB协议是文件和打印共享服务的基础，与它对应的端口号是445。*此外文件和打印共享服务和NETBIOS也有关联，它对应UDP的137，138和TCP的139服务。*(但是根据我在windows7上的测试，139端口和NETBIOS并不是我们进行NetBIOS会话查点、口令猜解的必要条件。)

从Vista，win7(公共网络模式)，Sever 2008后的默认配置中都不能从远程访问SMB，因为Windows防火墙的默认配置阻止了这种访问。但是域控是例外，它会自动配置重新开放SMB服务。以Windows 7为例，开启SMB服务的方法有三种：打开文件和打印共享，不需开启网络发现(默认关闭)、在Windows防火墙中为文件和打印共享开启例外以及在防火墙高级配置的入站规则里开启对应配置文件的文件和打印共享(smb-in)。其实三者是相互关联的，如果以第一种方式操作，那么防火墙会自动允许共享程序通过，高级配置中NetBIOS和SMB的相关规则也会开启。不过，如果采用第三种方式，在高级配置中不开启NetBIOS，经测试，不影响口令猜解和会话查点，但会影响NetBIOS，但会阻碍NetBIOS名字服务查点。三种操作依次如下图所示。

{% image fancybox fig-33 nocaption http://7xl89b.com1.z0.glb.clouddn.com/Windows口令猜解(445，3389)/o1.png "开启共享设置 001.png"  %}
{% image fancybox fig-33 nocaption http://7xl89b.com1.z0.glb.clouddn.com/Windows口令猜解(445，3389)/o2.png "开启例外 02.png" %}
{% image fancybox fig-33 nocaption http://7xl89b.com1.z0.glb.clouddn.com/Windows口令猜解(445，3389)/o3.png "开启smb 03.png" %}

windows可以自定义共享，也有默认共享，可以使用net share查看。其中IPC$用来建立会话链接。

建立空会话：net use \\IP\IPC$ "" /u:""

利用net use口令猜解：net use \\IP\IPC$ "PASSWORD" /u:"username"</br>
(如果只用账户名去登录目标系统不成功时，可以使用domain\username，其中domain可以直接使用IP替代，经测试win10符合这种情况)

medusa和hydra口令猜解：这两种工具都内置在kali中，具体的使用方法，请查看名ing提示帮助。其中hydra的提示中包含具体的模块，而medusa 需要在-M参数后使用Tab键来提示。


NetBIOS名字服务查点
---
NetBIOS名字服务查点一般适用于本地局域网

{% codeblock lang:bash %}
查点共享卷：net view \\IP(\\ServerName)
查点工作组和域：net view /domain
查点域里的计算机：net view /domain:DomainName
查点域控：nltest /dclist:DomainName
查点NetBIOS名字表: nbtstat -A IP
linux 工具(需下载): nmbscan
{% endcodeblock %}

相关服务
----

对应的服务有三个：server[lanmanserver],workstation[lanmanwork],Tcp/IP NetBIOS Helper。经测试，主要**禁用**server服务，口令猜解，空会话查点无法实施。可关闭445端口。另外在对应网卡中禁用NetBIOS可关闭139端口，如下图所示。

{% image fancybox center nocaption http://7xl89b.com1.z0.glb.clouddn.com/Windows口令猜解(445，3389)/0o4.png 350 350 "4.png" %}

关闭后可以用nmap扫描或者`netstat -an`来看下以上端口是否还处于监听状态。

防范对策
---

* 确保共享设置中文件和打印共享关闭(对应好配置文件：分为家庭，公用，域)
* 网络防火墙限制相应端口和主机防火墙限制相应程序和服务的访问
* 禁用相应的服务，从而关闭相应的端口。


终端服务/远程桌面服务
---
这个服务比较常见，通常我们用mstsc连接远程桌面的时候，就会用到它，它监听3389端口，可以利用hydra的rdp模块来猜解口令。

windows的默认配置中不开启。远程设置的开启有两个选项：一个是允许任意连接，二是仅允许网络身份级别连接。经测试，第二种方式只有windows上的远程桌面工具可以连接。而我们的自动化猜解只适用于在允许任意连接情况下。

[Ref]:
[IPC$命令详解 ](http://www.163164.com/jiqiao/163164com011.htm)
